# 快速开始指南

本指南帮助你快速上手 MCP Fleet 的新功能。

## 目录

- [创建带环境变量的 MCP 服务器](#创建带环境变量的-mcp-服务器)
- [查看端口池状态](#查看端口池状态)
- [环境变量的使用](#环境变量的使用)
- [多端口的使用场景](#多端口的使用场景)
- [常见问题](#常见问题)
- [最佳实践](#最佳实践)
- [故障排查](#故障排查)

## 创建带环境变量的 MCP 服务器

### 步骤：

1. **登录系统**后，点击"创建服务器"按钮

2. **填写基本信息**：
   - **名称**：输入服务器名称（如 `my-weather-tool`）
   - **描述**：简要描述服务器功能
   - **入口对象**：保持默认 `mcp` 或根据代码修改

3. **配置环境变量**（新功能）：
   
   点击 "添加环境变量" 按钮
   
   **示例 1 - API 密钥**：
   - 变量名: `API_KEY`
   - 变量值: `sk-1234567890abcdef`
   - 勾选 "密钥" 开关 ✓
   
   **示例 2 - 普通配置**：
   - 变量名: `DEBUG`
   - 变量值: `true`
   - 不勾选 "密钥"
   
   **示例 3 - 数据库连接**：
   - 变量名: `DATABASE_URL`
   - 变量值: `postgresql://user:pass@localhost/db`
   - 勾选 "密钥" 开关 ✓

4. **配置端口**（新功能）：
   
   **选项 1 - 自动分配**（推荐）：
   留空，系统会从端口池（30000-40000）自动分配
   
   **选项 2 - 指定单个端口**：
   输入: `8000`
   
   **选项 3 - 指定多个端口**：
   输入: `8000,8001,8002`
   （系统会将它们映射到容器的 8000, 8001, 8002 端口）

5. **上传代码文件**（.py, .zip, .tar.gz）

6. 点击"**创建**"按钮

## 查看端口池状态

### 步骤：

1. 导航到"**系统状态**"页面

2. 找到"**端口池状态**"卡片

3. 查看以下信息：

   **端口池概览**：
   - 端口范围：30000 - 40000
   - 总端口数：10000
   - 已分配：X 个
   - 可用：Y 个

   **使用率可视化**：
   - 进度条显示当前端口使用百分比

   **端口分配详情**：
   | 宿主机端口 | 服务器名称 | 状态 | 容器端口 |
   |-----------|----------|------|---------|
   | 30001     | server-1 | 运行中 | 8000    |
   | 30002     | server-1 | 运行中 | 8001    |
   | 30003     | server-2 | 已停止 | -       |

   **可用端口示例**：
   显示前 20 个可用端口供参考

## 环境变量的使用

### 在 Python MCP 服务器中访问环境变量

```python
import os
from mcp.server import Server

# 获取环境变量
api_key = os.getenv('API_KEY')
debug_mode = os.getenv('DEBUG', 'false')
database_url = os.getenv('DATABASE_URL')

# 使用环境变量
if debug_mode == 'true':
    print(f"Debug mode enabled")
    print(f"API Key: {api_key[:10]}...")  # 只显示前10个字符

# 在工具中使用
@server.tool()
async def get_weather(city: str):
    # 使用 API_KEY 调用外部服务
    response = await call_weather_api(city, api_key)
    return response
```

## 多端口的使用场景

### 场景 1：HTTP 服务 + WebSocket

```
端口配置: 8000,8001

容器内：
- 8000 -> HTTP API 服务
- 8001 -> WebSocket 服务

宿主机：
- 30001 -> HTTP API (映射到容器 8000)
- 30002 -> WebSocket (映射到容器 8001)
```

### 场景 2：主服务 + 管理界面

```
端口配置: 8000,9000

容器内：
- 8000 -> MCP 主服务
- 9000 -> 管理界面

宿主机：
- 30001 -> MCP 服务 (映射到容器 8000)
- 30002 -> 管理界面 (映射到容器 9000)
```

### 场景 3：多服务架构

```
端口配置: 8000,8001,8002

容器内：
- 8000 -> API Gateway
- 8001 -> 数据处理服务
- 8002 -> 缓存服务

宿主机：
- 30001 -> API Gateway
- 30002 -> 数据处理服务
- 30003 -> 缓存服务
```

## 常见问题

### Q1: 环境变量是否安全？

**A**: 当前版本环境变量以明文存储在数据库中。标记为"密钥"的变量在界面上会隐藏显示，但存储时仍为明文。建议在生产环境中：
- 不要存储极度敏感的信息
- 考虑使用外部密钥管理服务
- 等待后续版本的加密存储功能

### Q2: 端口冲突怎么办？

**A**: 系统会在启动容器前检查端口可用性：
- 如果指定的端口已被占用，会返回错误提示
- 建议使用自动分配功能，让系统选择可用端口
- 可以在"端口池状态"页面查看哪些端口已被使用

### Q3: 如何修改环境变量？

**A**: 当前版本需要：
1. 停止服务器
2. 删除服务器
3. 重新创建并配置新的环境变量

未来版本会支持在线编辑环境变量。

### Q4: 端口池范围可以修改吗？

**A**: 可以，但需要修改后端代码：
1. 打开 `backend/app/main.py`
2. 找到 `get_port_pool_status` 函数
3. 修改 `PORT_POOL_START` 和 `PORT_POOL_END` 常量
4. 重启后端服务

### Q5: 如何查看容器内的环境变量？

**A**: 可以通过以下方式：

1. **使用 Docker 命令**：
   ```bash
   docker inspect <container_id> | grep -A 20 "Env"
   ```

2. **进入容器查看**：
   ```bash
   docker exec -it <container_id> env
   ```

### Q6: 创建服务器后如何知道分配的端口？

**A**: 
- 创建成功后，服务器卡片会显示"分配端口"
- 即使服务器未启动，也能看到预分配的端口
- 可以在"系统状态"页面查看所有端口分配情况

## 最佳实践

### 1. 环境变量命名

- 使用大写字母和下划线：`API_KEY`, `DATABASE_URL`
- 避免使用特殊字符
- 使用描述性名称
- 遵循行业标准（如 `PORT`, `HOST`, `DEBUG`）

### 2. 端口配置

- **开发环境**：使用自动分配
- **生产环境**：如需固定端口，建议在 30000-35000 范围内选择
- 避免使用系统保留端口（0-1024）
- 为每个服务预留足够的端口（建议至少 2-3 个）

### 3. 密钥管理

- 所有 API 密钥、密码、令牌都应标记为"密钥"
- 定期轮换密钥
- 不要在代码中硬编码密钥
- 使用环境变量传递敏感信息

### 4. 端口规划

- 记录端口用途，避免混淆
- 定期清理不再使用的服务器以释放端口
- 使用有意义的服务器名称，方便识别端口归属
- 为不同类型的服务预留不同的端口段

### 5. 服务器命名

- 使用描述性名称：`weather-api-server` 而不是 `server1`
- 包含版本信息：`my-tool-v2`
- 使用小写字母和连字符
- 避免使用特殊字符

## 故障排查

### 问题 1：创建服务器时提示"端口不可用"

**症状**：
```
错误: 端口 8000 已被占用
```

**解决方案**：
1. 检查"端口池状态"页面，查看端口是否已被占用
2. 尝试使用自动分配（留空端口字段）
3. 检查是否有其他程序占用了该端口：
   ```bash
   # Linux/Mac
   lsof -i :8000
   
   # Windows
   netstat -ano | findstr :8000
   ```

### 问题 2：环境变量在容器中无法访问

**症状**：
代码中 `os.getenv('API_KEY')` 返回 `None`

**解决方案**：
1. 确认环境变量已正确添加（变量名不为空）
2. 检查容器日志：
   ```bash
   docker logs <container_id>
   ```
3. 进入容器验证：
   ```bash
   docker exec -it <container_id> env | grep API_KEY
   ```
4. 确认服务器已重启（修改环境变量后需要重启）

### 问题 3：多端口配置后只有第一个端口可用

**症状**：
配置了 `8000,8001,8002`，但只有 8000 端口能访问

**解决方案**：
1. 检查容器内的服务是否监听了所有配置的端口
2. 查看端口映射：
   ```bash
   docker port <container_id>
   ```
3. 确认防火墙没有阻止端口访问
4. 检查代码是否正确绑定到所有端口

### 问题 4：端口池显示不准确

**症状**：
明明有服务器在运行，但端口池显示 0 个已分配

**解决方案**：
1. 刷新页面
2. 检查后端日志是否有错误
3. 验证数据库中的端口数据：
   ```bash
   sqlite3 backend/mcp_platform.db "SELECT name, ports FROM mcp_servers;"
   ```

### 问题 5：服务器启动失败

**症状**：
服务器状态显示"错误"

**解决方案**：
1. 查看服务器日志（点击服务器卡片的"日志"按钮）
2. 检查 Docker 容器状态：
   ```bash
   docker ps -a | grep <server_name>
   ```
3. 查看容器日志：
   ```bash
   docker logs <container_id>
   ```
4. 常见原因：
   - 代码有语法错误
   - 缺少依赖包
   - 端口冲突
   - 环境变量配置错误

## 技术支持

如遇到问题，请提供以下信息：

1. **错误信息截图**
2. **服务器配置**（环境变量数量、端口配置）
3. **Docker 日志**：
   ```bash
   docker logs <container_id> 2>&1 | tail -50
   ```
4. **浏览器控制台错误**（按 F12 打开开发者工具）
5. **系统环境信息**：
   - 操作系统版本
   - Docker 版本：`docker --version`
   - Python 版本：`python --version`
   - Node.js 版本：`node --version`

## 下一步

- 查看 [部署指南](deployment.md) 了解生产环境部署
- 查看 [问题修复记录](fixes.md) 了解已知问题和解决方案
- 查看根目录的 `CHANGELOG.md` 了解最新功能更新

