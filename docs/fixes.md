# 问题修复记录

本文档记录了项目开发过程中遇到的问题及其解决方案。

## 修复日期
2025-12-03

---

## 端口管理相关修复

### 1. ✅ 创建服务器时立即分配端口

**问题描述**：
用户创建 MCP 服务器后，不知道分配的端口是什么，无法正常调用。

**解决方案**：
- 在创建服务器时（`POST /api/servers`）立即分配端口
- 如果用户指定了端口，检查端口是否可用
- 如果用户未指定端口，自动从端口池分配一个可用端口
- 将分配的端口保存到 `ports` 字段

**代码变更**：
- `backend/app/main.py` - `create_server` 函数
  - 添加端口预分配逻辑
  - 检查端口可用性
  - 自动分配端口

**效果**：
```json
{
  "name": "my-server",
  "ports": "30001",  // 创建时就分配了端口
  "status": "stopped",
  ...
}
```

### 2. ✅ 在服务器列表卡片中展示分配的端口

**问题描述**：
服务器卡片只显示运行时的端口（`host_port`），未启动的服务器看不到分配的端口。

**解决方案**：
- 修改服务器卡片组件，显示 `ports` 字段（分配的端口）
- 区分显示：
  - 未启动：显示"分配端口"
  - 已启动：显示"运行端口"

**代码变更**：
- `frontend/src/features/dashboard/components/server-card.tsx`
  - 添加分配端口的显示逻辑
  - 添加状态标签区分

**效果**：
- 未启动的服务器：显示 "分配端口: 30001 [未启动]"
- 运行中的服务器：显示 "运行端口: 30001"

### 3. ✅ 更新服务器时端口没有生效

**问题描述**：
使用 PUT 请求更新服务器的端口（`port: 3002`），但更新后 `ports` 字段仍然是 `null`。

**原因分析**：
- 前端发送的字段名是 `port`（单数）
- 后端 Schema 只定义了 `ports`（复数）
- 更新逻辑没有处理字段名不匹配的情况

**解决方案**：
1. 在 `MCPServerUpdate` Schema 中添加 `port` 字段（向后兼容）
2. 更新逻辑同时支持 `port` 和 `ports` 两种字段名
3. 优先使用 `ports`，如果没有则使用 `port`

**代码变更**：
- `backend/app/schemas.py` - 添加 `port: Optional[int]` 字段
- `backend/app/main.py` - 更新逻辑支持两种字段名

**测试结果**：
```bash
# 更新前
curl -X PUT .../servers/xxx -d '{"port": 3002}'
# 返回: "ports": null

# 更新后
curl -X PUT .../servers/xxx -d '{"port": 3002}'
# 返回: "ports": "3002" ✓
```

### 4. ✅ 添加端口冲突检测

**问题描述**：
更新服务器端口时，没有检查端口是否已被其他服务器占用，可能导致端口冲突。

**解决方案**：
在更新服务器端口时，添加以下检查：
1. 检查端口是否被其他服务器占用（数据库查询）
2. 检查端口是否被系统占用（socket 检查）
3. 如果端口被占用，返回 409 错误并说明被哪个服务器占用

**代码变更**：
- `backend/app/main.py` - `update_server` 函数添加端口冲突检测

**测试结果**：
```bash
# 尝试使用已被占用的端口
curl -X PUT .../servers/xxx -d '{"port": 3001}'

# 返回 409 错误
{
  "detail": "端口 3001 已被服务器 'test1' 占用"
}
```

### 5. ✅ 端口池状态使用实际数据

**问题描述**：
端口池显示的可用端口数（9997）不正确，应该是 10000。

**原因**：
原代码遍历所有 10000 个端口并逐个检查是否可用，导致：
1. 性能极差（需要检查 10000 次）
2. 可能超时
3. 显示不准确

**解决方案**：
- 改为计算理论可用端口数：`总端口数 - 已使用端口数`
- 只检查前 100 个端口，找出 20 个可用端口作为示例
- 大幅提升性能

**代码变更**：
- `backend/app/main.py` - `get_port_pool_status` 函数
  - 优化端口检查逻辑
  - 使用计算而非遍历

**效果**：
```json
{
  "total_ports": 10000,
  "used_ports_count": 0,
  "available_ports_count": 10000,  // 正确显示
  "sample_available_ports": [30000, 30001, ...]
}
```

### 6. ✅ 端口池状态文字优化

**问题描述**：
端口池状态显示"已使用"容易引起误解，因为：
- 即使容器未启动，端口也已经分配
- "已使用"暗示只有运行中的容器占用端口
- 实际上应该显示"已分配"更准确

**解决方案**：
1. 修改后端 API，统计所有服务器的分配端口（包括未启动的）
2. 将字段名从 `used_ports_count` 改为 `allocated_ports_count`
3. 将 `used_ports` 改为 `allocated_ports`
4. 更新前端显示文字为"已分配"

**代码变更**：
- `backend/app/main.py` - 修改端口统计逻辑和返回字段名
- `frontend/src/lib/api.ts` - 更新类型定义
- `frontend/src/features/system-status/index.tsx` - 更新显示文字

**效果对比**：

**之前**：
```
总端口数: 10000
已使用: 0  ← 误导（实际有端口被分配）
可用: 10000
```

**现在**：
```
总端口数: 10000
已分配: 2  ← 准确（test1: 3001, test2: 3002）
可用: 9998
```

### 7. ✅ 端口分配详情增强

**问题描述**：
端口分配表只显示"主端口/附加端口"，无法看出服务器的运行状态。

**解决方案**：
1. 在端口分配信息中添加服务器状态
2. 表格显示：宿主机端口、服务器名称、状态、容器端口
3. 状态使用不同颜色的 Badge 显示

**代码变更**：
- `backend/app/main.py` - 端口分配信息添加 `status` 字段
- `frontend/src/features/system-status/index.tsx` - 更新表格列和显示逻辑

**效果**：
| 宿主机端口 | 服务器名称 | 状态 | 容器端口 |
|-----------|----------|------|---------|
| 3001      | test1    | 🔴 错误 | -      |
| 3002      | test2    | ⚪ 已停止 | -    |

---

## React 相关修复

### 8. ✅ 修复 React input value 为 null 的警告

**问题描述**：
控制台报错：
```
`value` prop on `input` should not be null. 
Consider using an empty string to clear the component or `undefined` for uncontrolled components.
```

**原因**：
可选字段（description, ports, command, args）的初始值为 `undefined`，但 React 期望 `value` 为字符串或 `undefined`，不能是 `null`。

**解决方案**：
- 在所有可选输入字段中添加 `value={field.value || ''}`
- 确保 value 始终是字符串，而不是 null

**代码变更**：
- `frontend/src/features/dashboard/components/create-server-dialog.tsx`
  - description 字段
  - ports 字段
  - command 字段
  - args 字段

**效果**：
控制台不再显示警告。

---

## 完整的端口管理流程

### 创建服务器
```bash
# 1. 不指定端口（自动分配）
POST /api/servers
{
  "name": "server1",
  "file": "..."
}
# 返回: "ports": "30000"

# 2. 指定单个端口
POST /api/servers
{
  "name": "server2",
  "ports": "8000",
  "file": "..."
}
# 返回: "ports": "8000"

# 3. 指定多个端口
POST /api/servers
{
  "name": "server3",
  "ports": "8000,8001,8002",
  "file": "..."
}
# 返回: "ports": "8000,8001,8002"
```

### 更新服务器端口
```bash
# 支持两种字段名
PUT /api/servers/{id}
{
  "port": 3003  # 或 "ports": "3003"
}

# 端口冲突检测
PUT /api/servers/{id}
{
  "port": 3001  # 已被占用
}
# 返回 409: "端口 3001 已被服务器 'test1' 占用"
```

### 查看端口池状态
```bash
GET /api/system/ports

# 返回
{
  "total_ports": 10000,
  "allocated_ports_count": 2,  # 已分配
  "available_ports_count": 9998,
  "allocated_ports": [3001, 3002],
  "port_assignments": [
    {
      "server_name": "test1",
      "port": 3001,
      "status": "error"
    },
    {
      "server_name": "test2",
      "port": 3002,
      "status": "stopped"
    }
  ]
}
```

## API 变更总结

### 新增字段
- `MCPServerUpdate.port` - 支持单个端口更新（向后兼容）

### 字段重命名
| 旧字段名 | 新字段名 | 说明 |
|---------|---------|------|
| `used_ports_count` | `allocated_ports_count` | 更准确的描述 |
| `used_ports` | `allocated_ports` | 更准确的描述 |

### 新增端口分配信息字段
- `status` - 服务器状态（running/stopped/error/building）
- `is_allocated` - 是否已分配
- `is_running` - 是否正在运行

## 使用建议

### 1. 端口分配策略

**自动分配（推荐）**：
- 创建服务器时不填写端口
- 系统自动从端口池分配
- 避免端口冲突

**手动指定**：
- 需要固定端口时使用
- 可以指定多个端口（逗号分隔）
- 系统会检查端口可用性

### 2. 查看端口信息

**创建后立即查看**：
1. 创建服务器后，在列表中找到该服务器
2. 查看"分配端口"信息
3. 记录端口号供后续使用

**启动后查看**：
1. 启动服务器后，端口信息更新为"运行端口"
2. 如果配置了多端口，会显示"(多端口)"标识
3. 可以通过系统状态页面查看详细的端口映射

### 3. 端口管理

**查看端口使用情况**：
- 导航到"系统状态"页面
- 查看"端口池状态"卡片
- 了解哪些端口已被使用

**避免端口冲突**：
- 使用自动分配功能
- 或在创建前检查端口池状态
- 选择未被使用的端口

## 注意事项

1. **端口分配时机**：
   - 端口在创建服务器时分配
   - 不是在启动时分配
   - 这样用户可以提前知道端口信息

2. **端口保留**：
   - 分配的端口会保留给该服务器
   - 即使服务器未启动
   - 删除服务器后端口才会释放

3. **端口池范围**：
   - 默认：30000-40000
   - 可以在后端配置中修改
   - 建议不要使用系统保留端口（0-1024）

4. **性能优化**：
   - 端口池状态查询已优化
   - 不再遍历所有端口
   - 响应速度大幅提升

5. **向后兼容**：
   - 同时支持 `port` 和 `ports` 字段
   - 旧的 API 调用仍然有效

## 后续改进建议

1. **端口释放机制**：
   - 自动回收长期未使用的端口
   - 提供手动释放端口的功能

2. **端口预留**：
   - 允许管理员预留特定端口
   - 防止自动分配占用重要端口

3. **端口使用统计**：
   - 记录端口使用历史
   - 提供端口使用趋势图表

4. **端口分组**：
   - 支持为不同项目分配端口段
   - 更好的端口管理和隔离

5. **批量端口操作**：
   - 批量释放未使用的端口
   - 批量重新分配端口

6. **端口范围管理**：
   - 支持配置多个端口范围
   - 不同项目使用不同端口段

